## DO NOT EDIT!
# This file was provisioned by OpenTofu
# File origin: https://github.com/aetheric-oss/tofu-github/tree/main/src/modules/vars/templates/rust/svc/.compose/aetheric-svc/rust-test.yaml

---

# Define extension with an anchor so it can be used as an alias to merge in the fields
x-test: &test
  user: ${DOCKER_USER_ID:-0}:${DOCKER_GROUP_ID:-0}
  image: ${RUST_IMAGE_NAME}:${RUST_IMAGE_TAG}
  networks:
    - aetheric-realm
  volumes:
    - type: bind
      source: "${SOURCE_PATH:-../..}/"
      target: "/usr/src/app"
    - type: bind
      source: "${SOURCE_PATH:-../..}/.cargo/registry"
      target: "/usr/local/cargo/registry"
    - type: bind
      source: ../../logs/
      target: /logs/
  configs:
    - source: log4rs
      target: ${LOG_CONFIG:-/log4rs.yaml}
    - source: dot-env
      target: /.env
  security_opt:
    - seccomp:unconfined

services:
  unit-test:
    <<: *test
    container_name: aetheric-${PACKAGE_NAME}-ut
    command: sh -c "
      cargo test \
        --manifest-path '${CARGO_MANIFEST_PATH:-Cargo.toml}' \
        --workspace \
        --features $${PACKAGE_FEATURES:-default};
      chown -R ${DOCKER_USER_ID:-0}:${DOCKER_GROUP_ID:-0} /usr/src/app/*"
    profiles:
      - unit-test

  integration-test:
    <<: *test
    container_name: aetheric-${PACKAGE_NAME}-it
    command: sh -c "
      cargo test \
        --manifest-path '${CARGO_MANIFEST_PATH:-Cargo.toml}' \
        --workspace \
        --test integration_test \
        --features $${PACKAGE_FEATURES:-default};
      chown -R ${DOCKER_USER_ID:-0}:${DOCKER_GROUP_ID:-0} /usr/src/app/*"
    environment:
      - PACKAGE_FEATURES=${PACKAGE_IT_FULL_FEATURES}
      - SERVER_HOSTNAME=aetheric-${PACKAGE_NAME}-web-server
    depends_on:
      web-server:
        condition: service_healthy
    profiles:
      - integration-test

  example:
    <<: *test
    container_name: aetheric-${PACKAGE_NAME}-example
    command: cargo run --manifest-path "${CARGO_MANIFEST_PATH:-Cargo.toml}" --example "${EXAMPLE_TARGET:-grpc}"
    environment:
      - SERVER_HOSTNAME=aetheric-${PACKAGE_NAME}-web-server-stubbed
      - SERVER_PORT_REST=${DOCKER_PORT_REST:-8000}
    depends_on:
      web-server-stubbed:
        condition: service_healthy
    profiles:
      - example

