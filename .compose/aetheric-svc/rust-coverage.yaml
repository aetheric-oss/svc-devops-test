## DO NOT EDIT!
# This file was provisioned by OpenTofu
# File origin: https://github.com/aetheric-oss/tofu-github/tree/main/src/modules/vars/templates/rust/svc/.compose/aetheric-svc/rust-coverage.yaml

---

# Define extension with an anchor so it can be used as an alias to merge in the fields
x-coverage: &coverage
  extends:
    file: rust-test.yaml
    service: unit-test
  command: sh -c "
    cargo tarpaulin \
      -l -v -t 600 \
      --manifest-path '${CARGO_MANIFEST_PATH:-Cargo.toml}' \
      --engine llvm \
      --workspace \
      --tests \
      --features $${PACKAGE_FEATURES:-default} \
      --out Lcov \
      --output-dir coverage/ ;
    sed -e 's/\\/usr\\/src\\/app\\///g' -i coverage/lcov.info &&
    find . -name *.profraw -delete &&
    chown -R ${DOCKER_USER_ID:-0}:${DOCKER_GROUP_ID:-0} /usr/src/app/*"

services:
  ut-coverage:
    <<: *coverage
    container_name: aetheric-${PACKAGE_NAME}-ut-coverage
    environment:
      - PACKAGE_FEATURES=${PACKAGE_UT_FEATURES}
      - SERVER_HOSTNAME=aetheric-${PACKAGE_NAME}-web-server-stubbed
    depends_on:
      web-server-stubbed:
        condition: service_healthy
    profiles:
      - ut-coverage

  # Runs coverage for integration tests. Will use stubbed backends since we only want to see if all code is covered.
  # For full integration tests, the 'integration-test' target is available
  it-coverage:
    <<: *coverage
    container_name: aetheric-${PACKAGE_NAME}-it-coverage
    environment:
      - PACKAGE_FEATURES=${PACKAGE_IT_FEATURES}
      - SERVER_HOSTNAME=aetheric-${PACKAGE_NAME}-web-server
    depends_on:
      web-server-stubbed:
        condition: service_healthy
    profiles:
      - it-coverage
